<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Edit Specification XML</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-50">

    <div id="header"></div>

    <div class="max-w-3xl mx-auto mt-10 p-6 bg-white rounded-2xl shadow">
        <h2 class="text-2xl font-bold mb-4 text-indigo-600">Edit Specification XML</h2>

        <label class="block mb-2 font-semibold text-gray-700" for="validationType">Validation Type</label>
        <select id="validationType" class="mb-4 w-full p-2 border rounded">
            <option value="rng">RNG</option>
            <option value="xsd">XSD</option>
        </select>

        <textarea id="xmlInput" class="w-full h-64 p-3 border rounded mb-4 font-mono text-sm" spellcheck="false"
            placeholder="Loading XML..."></textarea>

        <button id="submitBtn"
            class="bg-indigo-600 text-white px-6 py-3 rounded-full font-semibold hover:bg-indigo-700 transition">
            Save Changes
        </button>

        <div id="result" class="mt-4"></div>
    </div>

    <script src="../js/header.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/vkiryukhin/vkBeautify/vkbeautify.js"></script>
    <script>
        const submitBtn = document.getElementById('submitBtn');
        const resultDiv = document.getElementById('result');
        const xmlInput = document.getElementById('xmlInput');
        const validationTypeSelect = document.getElementById('validationType');

        const params = new URLSearchParams(window.location.search);
        const id = params.get('id');

        async function loadXml() {
            try {
                const response = await fetch(`http://localhost:5095/api/Specifications/${id}`, {
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('accessToken'),
                        'Accept': 'application/xml'
                    }
                });
                if (!response.ok) throw new Error('Failed to load specification XML.');
                const xmlText = await response.text();
                const prettyXml = vkbeautify.xml(xmlText, 2);
                xmlInput.value = removeCustomId(prettyXml);
                resultDiv.innerHTML = '';
            } catch (err) {
                resultDiv.innerHTML = `<p class="text-red-600 font-semibold">${err.message}</p>`;
                xmlInput.placeholder = "Failed to load XML.";
            }
        }

        loadXml();

        submitBtn.addEventListener('click', async () => {
            const xmlData = xmlInput.value.trim();
            const validationType = validationTypeSelect.value;
            resultDiv.innerHTML = '';

            if (!xmlData) {
                resultDiv.innerHTML = "<p class='text-red-600'>Please enter some XML data.</p>";
                return;
            }

            try {
                const url = `http://localhost:5095/api/Specifications/${id}?validationType=${encodeURIComponent(validationType)}`;
                const response = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/xml',
                        'Authorization': 'Bearer ' + localStorage.getItem('accessToken')
                    },
                    body: xmlData
                });

                if (response.ok) {
                    resultDiv.innerHTML = "<p class='text-green-600 font-semibold'>Specification updated successfully!</p>";
                } else {
                    let errorText = 'XML validation failed.';
                    try {
                        const contentType = response.headers.get("content-type");
                        if (contentType && contentType.includes("application/json")) {
                            const errorJson = await response.json();
                            errorText = errorJson.message || JSON.stringify(errorJson, null, 2);
                        } else {
                            errorText = await response.text();
                        }
                    } catch (e) {
                        errorText = 'Unable to parse server error response.';
                    }
                    console.error('Validation error response:', errorText);
                    resultDiv.innerHTML = `<pre class='text-red-600 whitespace-pre-wrap'>${escapeHtml(errorText)}</pre>`;
                }
            } catch (err) {
                resultDiv.innerHTML = "<p class='text-red-600'>Error connecting to server.</p>";
                console.error(err);
            }
        });

        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function removeCustomId(xml) {
            return xml.replace(/<customId>.*?<\/customId>/gs, '');
        }
    </script>
</body>

</html>